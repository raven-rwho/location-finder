/** serializr - (c) Michel Weststrate 2016 - MIT Licensed */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define("serializr",["exports"],r):r(e.serializr={})}(this,function(e){"use strict";function r(e){if(e)throw new Error(e)}function n(e){var r=!1;return function(){if(!r)return r=!0,e.apply(null,arguments);t(!1,"callback was invoked twice")}}function t(e,r){if(!e)throw new Error("[serializr] "+(r||"Illegal State"))}function i(e,r,n){if(0!==e.length){var t=e.length,i=[],o=!1,a=function(e,r,a){r?o||(o=!0,n(r)):(i[e]=a,0==--t&&n(null,i))};e.forEach(function(e,n){r(e,a.bind(null,n))})}else n(null,[])}function o(e){return null===e||"object"!=typeof e&&"function"!=typeof e}function a(e){return e&&e.factory&&e.props}function s(e){return e&&e.serializer&&e.deserializer}function u(e){return"object"==typeof e&&!!e.jsonname}function c(e){return"object"==typeof e&&!0===e.identifier}function f(e,r){for(;e;){if(e===r)return!0;e=e["extends"]}return!1}function l(e){return e&&"function"==typeof e.keys&&"function"==typeof e.clear}function p(e){for(t(a(e));e;){for(var r in e.props)if("object"==typeof e.props[r]&&!0===e.props[r].identifier)return r;e=e["extends"]}return null}function d(e){return e?a(e)?e:a(e.serializeInfo)?e.serializeInfo:e.constructor&&e.constructor.serializeInfo?e.constructor.serializeInfo:void 0:null}function h(e,r){return t(a(r)),e.serializeInfo=r}function m(e,r,n){t(e!==Object,"one cannot simply put define a model schema for Object"),t("function"==typeof e,"expected constructor function");var i={targetClass:e,factory:n||function(){return new e},props:r};if(e.prototype.constructor!==Object){var o=d(e.prototype.constructor);o&&o.targetClass!==e&&(i["extends"]=o)}return h(e,i),i}function y(){return{serializer:function(e){return t(o(e),"this value is not primitive: "+e),e},deserializer:function(e,r){o(e)?r(null,e):r("[serializr] this value is not primitive: "+e)}}}function g(e){var r=e.toString().replace(D,""),n=r.slice(r.indexOf("(")+1,r.indexOf(")")).match(M);return null===n&&(n=[]),n}function v(e,r,n,i){t(arguments.length>=2,"too few arguments. Please use @serializable as property decorator");var o;if(n===undefined&&"function"==typeof r&&r.prototype&&i!==undefined&&"number"==typeof i){t(s(e),"Constructor params must use alias(name)"),t(e.jsonname,"Constructor params must use alias(name)");var a=g(r);a.length>=i&&(n=a[i],e.paramNumber=i,i=undefined,r=r.prototype,o=function(e){for(var n=[],t=0;t<r.constructor.length;t++)Object.keys(e.modelSchema.props).forEach(function(r){var i=e.modelSchema.props[r];i.paramNumber===t&&(n[t]=e.json[i.jsonname])});return new(Function.prototype.bind.apply(r.constructor,[null].concat(n)))})}t("string"==typeof n,"incorrect usage of @serializable decorator");var u=d(r);return u&&r.constructor.hasOwnProperty("serializeInfo")||(u=m(r.constructor,{},o)),u&&u.targetClass!==r.constructor&&(u=m(r.constructor,{},o)),u.props[n]=e,!i||i.get||i.set||(i.writable=!0),i}function b(e,r){t(1===arguments.length||2===arguments.length,"serialize expects one or 2 arguments");var n=1===arguments.length?e:r,i=1===arguments.length?null:e;if(Array.isArray(n)){if(0===n.length)return[];i||(i=d(n[0]))}else i||(i=d(n));return t(!!i,"Failed to find default schema for "+e),Array.isArray(n)?n.map(function(e){return z(i,e)}):z(i,n)}function z(e,r){t(e&&"object"==typeof e,"Expected schema"),t(r&&"object"==typeof r,"Expected object");var n;return n=e["extends"]?z(e["extends"],r):{},Object.keys(e.props).forEach(function(i){var o=e.props[i];if("*"===i)return t(!0===o,"prop schema '*' can onle be used with 'true'"),void j(e,r,n);if(!0===o&&(o=N),!1!==o){var a=o.serializer(r[i],i,r);a!==P&&(n[o.jsonname||i]=a)}}),n}function j(e,r,n){for(var t in r)if(r.hasOwnProperty(t)&&!(t in e.props)){var i=r[t];o(i)&&(n[t]=i)}}function x(e,n,t,i,o){this.parentContext=e,this.isRoot=!e,this.pendingCallbacks=0,this.pendingRefsCount=0,this.onReadyCb=i||r,this.json=t,this.target=null,this.hasError=!1,this.modelSchema=n,this.isRoot?(this.rootContext=this,this.args=o,this.pendingRefs={},this.resolvedRefs={}):(this.rootContext=e.rootContext,this.args=e.args)}function R(e,r){for(var n in e.props)if("object"==typeof e.props[n]&&e.props[n].jsonname===r)return!0;return!1}function C(e,r,n){for(var i in n)if(!(i in e.props||R(e,i))){var a=n[i];t(o(a),"encountered non primitive value while deserializing '*' properties in property '"+i+"': "+a),r[i]=a}}function S(e,n,i,o,a){if(null!==i&&i!==undefined){var s=new x(e,n,i,o,a),u=n.factory(s);t(!!u,"No object returned from factory"),s.target=u;var c=s.createCallback(r);return w(s,n,i,u),c(),u}o(null,null)}function w(e,r,n,i){r["extends"]&&w(e,r["extends"],n,i),Object.keys(r.props).forEach(function(o){var a=r.props[o];if("*"===o)return t(!0===a,"prop schema '*' can onle be used with 'true'"),void C(r,i,n);if(!0===a&&(a=N),!1!==a){var s=a.jsonname||o;s in n&&a.deserializer(n[s],e.rootContext.createCallback(function(e){e!==P&&(i[o]=e)}),e,i[o])}})}function k(e,r,n){n.rootContext.resolve(n.modelSchema,e,n.target)}function E(e){return t("object"==typeof e||"function"==typeof e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies."),{serializer:function(r){return e=d(e),t(a(e),"expected modelSchema, got "+e),null===r||r===undefined?r:b(e,r)},deserializer:function(r,n,i){t(a(e=d(e)),"expected modelSchema, got "+e),null===r||r===undefined?n(null,r):S(i,e,r,n)}}}function O(e){return function(r,n,t){t.rootContext.await(e,r,n)}}function A(e,r){function n(){if(o=!0,t("string"!=typeof e||r,"if the reference target is specified by attribute name, a lookup function is required"),t(!r||"function"==typeof r,"second argument should be a lookup function"),"string"==typeof e)i=e;else{var n=d(e);t(a(n),"expected model schema or string as first argument for 'ref', got "+n),r=r||O(n),t(!!(i=p(n)),"provided model schema doesn't define an identifier() property and cannot be used by 'ref'.")}}t(!!e,"No modelschema provided. If you are importing it from another file be aware of circular dependencies.");var i,o=!1;return{serializer:function(e){return o||n(),e?e[i]:null},deserializer:function(e,t,i){o||n(),null===e||e===undefined?t(null,e):r(e,t,i)}}}function I(e){return e=e||N,t(s(e),"expected prop schema as first argument"),t(!u(e),"provided prop is aliased, please put aliases first"),{serializer:function(r){return t(r&&"length"in r&&"map"in r,"expected array (like) object"),r.map(e.serializer)},deserializer:function(r,n,t){Array.isArray(r)?i(r,function(r,n){return e.deserializer(r,n,t)},n):n("[serializr] expected JSON array")}}}var P="undefined"!=typeof Symbol?Symbol("SKIP"):{SKIP:!0},N=y(),D=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,M=/([^\s,]+)/g;x.prototype.createCallback=function(e){return this.pendingCallbacks++,n(function(r,n){r?this.hasError||(this.hasError=!0,this.onReadyCb(r)):this.hasError||(e(n),--this.pendingCallbacks===this.pendingRefsCount&&(this.pendingRefsCount>0?this.onReadyCb(new Error('Unresolvable references in json: "'+Object.keys(this.pendingRefs).filter(function(e){return this.pendingRefs[e].length>0},this).join('", "')+'"')):this.onReadyCb(null,this.target)))}.bind(this))},x.prototype.await=function(e,r,n){if(t(this.isRoot),r in this.resolvedRefs){var i=this.resolvedRefs[r].filter(function(r){return f(r.modelSchema,e)})[0];if(i)return void n(null,i.value)}this.pendingRefsCount++,this.pendingRefs[r]||(this.pendingRefs[r]=[]),this.pendingRefs[r].push({modelSchema:e,uuid:r,callback:n})},x.prototype.resolve=function(e,r,n){if(t(this.isRoot),this.resolvedRefs[r]||(this.resolvedRefs[r]=[]),this.resolvedRefs[r].push({modelSchema:e,value:n}),r in this.pendingRefs)for(var i=this.pendingRefs[r].length-1;i>=0;i--){var o=this.pendingRefs[r][i];f(e,o.modelSchema)&&(this.pendingRefs[r].splice(i,1),this.pendingRefsCount--,o.callback(null,n))}},e.createSimpleSchema=function(e){return{factory:function(){return{}},props:e}},e.createModelSchema=m,e.getDefaultModelSchema=d,e.setDefaultModelSchema=h,e.serializable=function(e,r,n){if(1===arguments.length){var i=!0===e?N:e;return t(s(i),"@serializable expects prop schema"),v.bind(null,i)}return v(y(),e,r,n)},e.serialize=b,e.serializeAll=function(e){t(1===arguments.length&&"function"==typeof e,"@serializeAll can only be used as class decorator");var r=d(e);return r&&e.hasOwnProperty("serializeInfo")||h(e,r=m(e,{})),d(e).props["*"]=!0,e},e.deserialize=function(e,n,o,s){if(t(arguments.length>=2,"deserialize expects at least 2 arguments"),e=d(e),t(a(e),"first argument should be model schema"),Array.isArray(n)){var u=[];return i(n,function(r,n){var t=S(null,e,r,n,s);u.push(t)},o||r),u}return S(null,e,n,o,s)},e.update=function(e,n,i,o,s){2===arguments.length||"function"==typeof arguments[2]?(e=d(n=arguments[0]),i=arguments[1],o=arguments[2],s=arguments[3]):e=d(e),t(a(e),"update failed to determine schema"),t("object"==typeof n&&n&&!Array.isArray(n),"update needs an object");var u=new x(null,e,i,o,s);u.target=n;var c=u.createCallback(r);w(u,e,i,n),c()},e.primitive=y,e.identifier=function(e){return t(!e||"function"==typeof e,"First argument should be omitted or function"),{identifier:!0,serializer:N.serializer,deserializer:function(r,n,t){N.deserializer(r,function(r,i){k(i,t.target,t),e&&e(i,t.target,t),n(r,i)})}}},e.date=function(){return{serializer:function(e){return null===e||e===undefined?e:(t(e instanceof Date,"Expected Date object"),e.getTime())},deserializer:function(e,r){null===e||e===undefined?r(null,e):r(null,new Date(e))}}},e.alias=function(e,r){return t(e&&"string"==typeof e,"expected prop name as first argument"),r=r&&!0!==r?r:N,t(s(r),"expected prop schema as second argument"),t(!u(r),"provided prop is already aliased"),{jsonname:e,serializer:r.serializer,deserializer:r.deserializer,identifier:c(r)}},e.custom=function(e,r){return t("function"==typeof e,"first argument should be function"),t("function"==typeof r,"second argument should be function"),{serializer:e,deserializer:function(e,n,t,i){n(null,r(e,t,i))}}},e.object=E,e.reference=A,e.list=I,e.map=function(e){return e=e||N,t(s(e),"expected prop schema as first argument"),t(!u(e),"provided prop is aliased, please put aliases first"),{serializer:function(r){t(r&&"object"==typeof r,"expected object or Map");var n={};if(l(r))r.forEach(function(r,t){n[t]=e.serializer(r)});else for(var i in r)n[i]=e.serializer(r[i]);return n},deserializer:function(r,n,t,i){if(r&&"object"==typeof r){var o=Object.keys(r);I(e).deserializer(o.map(function(e){return r[e]}),function(e,r){if(e)n(e);else{var t,a=l(i);a?(i.clear(),t=i):t={};for(var s=0,u=o.length;s<u;s++)a?t.set(o[s],r[s]):t[o[s]]=r[s];n(null,t)}},t)}else n("[serializr] expected JSON object")}}},e.mapAsArray=function(e,r){return e=e||N,t(s(e),"expected prop schema as first argument"),t(!!r,"expected key property name as second argument"),{serializer:function(r){var n=[];return r.forEach(function(r,t){n.push(e.serializer(r))}),n},deserializer:function(n,t,i,o){I(e).deserializer(n,function(e,i){if(e)t(e);else{var a,s=l(o);s?(o.clear(),a=o):a={};for(var u=0,c=n.length;u<c;u++)s?a.set(i[u][r],i[u]):a[i[u][r].toString()]=i[u];t(null,a)}},i)}}},e.SKIP=P,e.child=E,e.ref=A,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=serializr.min.js.map
